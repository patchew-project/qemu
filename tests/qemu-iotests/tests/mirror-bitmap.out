
=== Bitmap Sync never with simulated failure ===

--- Preparing image & VM ---

{"execute": "blockdev-add", "arguments": {"driver": "qcow2", "file": {"driver": "file", "filename": "TEST_DIR/PID-img"}, "node-name": "drive0"}}
{"return": {}}

--- Write #0 ---

write -P0x49 0x0000000 0x10000
{"return": ""}
write -P0x6c 0x0100000 0x10000
{"return": ""}
write -P0x6f 0x2000000 0x10000
{"return": ""}
write -P0x76 0x3ff0000 0x10000
{"return": ""}
{
  "bitmaps": {}
}

--- Reference mirror #0 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_0", "sync": "full", "target": "ref_target_0"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_0"}}
{"return": {}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_0 ---
{}
{}

--- Add Bitmap ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "bitmap0", "node": "drive0"}}
{"return": {}}

--- Write #1 ---

write -P0x65 0x0000000 0x10000
{"return": ""}
write -P0x77 0x00f8000 0x10000
{"return": ""}
write -P0x72 0x2008000 0x10000
{"return": ""}
write -P0x69 0x3fe0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 393216,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 6 dirty sectors; have 6. OK!

--- Reference mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_1", "sync": "full", "target": "ref_target_1"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_1"}}
{"return": {}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_1 ---
{}
{}

--- Prepare bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_1", "sync": "full", "target": "mirror_target_1"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "mirror_1"}}
{"return": {}}
{"data": {"device": "mirror_1", "len": 393216, "offset": 393216, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"execute": "job-cancel", "arguments": {"id": "mirror_1"}}
{"return": {}}
{"data": {"id": "mirror_1", "type": "mirror"}, "event": "BLOCK_JOB_PENDING", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_1", "len": 393216, "offset": 393216, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_CANCELLED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_1 ---
{}
{}

--- Post-process bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 393216,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 6 dirty sectors; have 6. OK!

--- Reference mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_2", "sync": "full", "target": "ref_target_2"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_2"}}
{"return": {}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_2 ---
{}
{}

--- Prepare bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_2", "sync": "full", "target": "mirror_target_2"}}
{"return": {}}
--- Write #2 ---

write -P0x74 0x0010000 0x10000
{"return": ""}
write -P0x69 0x00e8000 0x10000
{"return": ""}
write -P0x6e 0x2018000 0x10000
{"return": ""}
write -P0x67 0x3fe0000 0x20000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": true,
        "count": 0,
        "granularity": 65536,
        "name": "mirror-bitmap",
        "persistent": false,
        "recording": false
      },
      {
        "busy": false,
        "count": 655360,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 10 dirty sectors; have 10. OK!

--- Detaching mirror_target_2 ---
{}
{}

--- Post-process bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

= Checking Bitmap bitmap0 =
expecting 10 dirty sectors; have 10. OK!

--- Write #3 ---

write -P0xaa 0x0010000 0x30000
{"return": ""}
write -P0xbb 0x00d8000 0x10000
{"return": ""}
write -P0xcc 0x2028000 0x10000
{"return": ""}
write -P0xdd 0x3fc0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 983040,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 15 dirty sectors; have 15. OK!

--- Reference mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_3", "sync": "full", "target": "ref_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_3"}}
{"return": {}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_3 ---
{}
{}

--- Prepare bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_3", "sync": "full", "target": "mirror_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"device": "mirror_3", "len": 983040, "offset": 983040, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"execute": "job-finalize", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"id": "mirror_3", "type": "mirror"}, "event": "BLOCK_JOB_PENDING", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_3", "len": 983040, "offset": 983040, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_3 ---
{}
{}

--- Post-process bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 983040,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 15 dirty sectors; have 15. OK!

--- Cleanup ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "bitmap0", "node": "drive0"}}
{"return": {}}
{
  "bitmaps": {}
}

--- Verification ---

qemu_img compare "TEST_DIR/PID-bsync1" "TEST_DIR/PID-fmirror1" ==> Identical, OK!
qemu_img compare "TEST_DIR/PID-bsync2" "TEST_DIR/PID-fmirror2" ==> Mismatch, OK!
qemu_img compare "TEST_DIR/PID-bsync3" "TEST_DIR/PID-fmirror3" ==> Identical, OK!
qemu_img compare "TEST_DIR/PID-img" "TEST_DIR/PID-fmirror3" ==> Identical, OK!


=== Bitmap Sync never with intermediate failure ===

--- Preparing image & VM ---

{"execute": "blockdev-add", "arguments": {"driver": "qcow2", "file": {"driver": "blkdebug", "image": {"driver": "file", "filename": "TEST_DIR/PID-img"}, "inject-error": [{"errno": 5, "event": "read_aio", "immediately": false, "once": true, "state": 3}, {"errno": 5, "event": "read_aio", "immediately": false, "once": true, "state": 4}], "set-state": [{"event": "flush_to_disk", "new-state": 2, "state": 1}, {"event": "read_aio", "new-state": 3, "state": 2}, {"event": "read_aio", "new-state": 4, "state": 3}]}, "node-name": "drive0"}}
{"return": {}}

--- Write #0 ---

write -P0x49 0x0000000 0x10000
{"return": ""}
write -P0x6c 0x0100000 0x10000
{"return": ""}
write -P0x6f 0x2000000 0x10000
{"return": ""}
write -P0x76 0x3ff0000 0x10000
{"return": ""}
{
  "bitmaps": {}
}

--- Reference mirror #0 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_0", "sync": "full", "target": "ref_target_0"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_0"}}
{"return": {}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_0 ---
{}
{}

--- Add Bitmap ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "bitmap0", "node": "drive0"}}
{"return": {}}

--- Write #1 ---

write -P0x65 0x0000000 0x10000
{"return": ""}
write -P0x77 0x00f8000 0x10000
{"return": ""}
write -P0x72 0x2008000 0x10000
{"return": ""}
write -P0x69 0x3fe0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 393216,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 6 dirty sectors; have 6. OK!

--- Reference mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_1", "sync": "full", "target": "ref_target_1"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_1"}}
{"return": {}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_1 ---
{}
{}

{"return": ""}

--- Prepare bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_1", "sync": "full", "target": "mirror_target_1"}}
{"return": {}}
{"data": {"action": "report", "device": "mirror_1", "operation": "read"}, "event": "BLOCK_JOB_ERROR", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"action": "report", "device": "mirror_1", "operation": "read"}, "event": "BLOCK_JOB_ERROR", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_1", "error": "Input/output error", "len": 393216, "offset": 65536, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_1 ---
{}
{}

--- Post-process bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 393216,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 6 dirty sectors; have 6. OK!

--- Reference mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_2", "sync": "full", "target": "ref_target_2"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_2"}}
{"return": {}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_2 ---
{}
{}

--- Prepare bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_2", "sync": "full", "target": "mirror_target_2"}}
{"return": {}}
--- Write #2 ---

write -P0x74 0x0010000 0x10000
{"return": ""}
write -P0x69 0x00e8000 0x10000
{"return": ""}
write -P0x6e 0x2018000 0x10000
{"return": ""}
write -P0x67 0x3fe0000 0x20000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": true,
        "count": 0,
        "granularity": 65536,
        "name": "mirror-bitmap",
        "persistent": false,
        "recording": false
      },
      {
        "busy": false,
        "count": 655360,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 10 dirty sectors; have 10. OK!

--- Detaching mirror_target_2 ---
{}
{}

--- Post-process bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

= Checking Bitmap bitmap0 =
expecting 10 dirty sectors; have 10. OK!

--- Write #3 ---

write -P0xaa 0x0010000 0x30000
{"return": ""}
write -P0xbb 0x00d8000 0x10000
{"return": ""}
write -P0xcc 0x2028000 0x10000
{"return": ""}
write -P0xdd 0x3fc0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 983040,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 15 dirty sectors; have 15. OK!

--- Reference mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_3", "sync": "full", "target": "ref_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_3"}}
{"return": {}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_3 ---
{}
{}

--- Prepare bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_3", "sync": "full", "target": "mirror_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"device": "mirror_3", "len": 983040, "offset": 983040, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"execute": "job-finalize", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"id": "mirror_3", "type": "mirror"}, "event": "BLOCK_JOB_PENDING", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_3", "len": 983040, "offset": 983040, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_3 ---
{}
{}

--- Post-process bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 983040,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 15 dirty sectors; have 15. OK!

--- Cleanup ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "bitmap0", "node": "drive0"}}
{"return": {}}
{
  "bitmaps": {}
}

--- Verification ---

qemu_img compare "TEST_DIR/PID-bsync1" "TEST_DIR/PID-fmirror1" ==> Mismatch, OK!
qemu_img compare "TEST_DIR/PID-bsync2" "TEST_DIR/PID-fmirror2" ==> Mismatch, OK!
qemu_img compare "TEST_DIR/PID-bsync3" "TEST_DIR/PID-fmirror3" ==> Identical, OK!
qemu_img compare "TEST_DIR/PID-img" "TEST_DIR/PID-fmirror3" ==> Identical, OK!


=== Bitmap Sync never without failure ===

--- Preparing image & VM ---

{"execute": "blockdev-add", "arguments": {"driver": "qcow2", "file": {"driver": "file", "filename": "TEST_DIR/PID-img"}, "node-name": "drive0"}}
{"return": {}}

--- Write #0 ---

write -P0x49 0x0000000 0x10000
{"return": ""}
write -P0x6c 0x0100000 0x10000
{"return": ""}
write -P0x6f 0x2000000 0x10000
{"return": ""}
write -P0x76 0x3ff0000 0x10000
{"return": ""}
{
  "bitmaps": {}
}

--- Reference mirror #0 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_0", "sync": "full", "target": "ref_target_0"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_0"}}
{"return": {}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_0 ---
{}
{}

--- Add Bitmap ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "bitmap0", "node": "drive0"}}
{"return": {}}

--- Write #1 ---

write -P0x65 0x0000000 0x10000
{"return": ""}
write -P0x77 0x00f8000 0x10000
{"return": ""}
write -P0x72 0x2008000 0x10000
{"return": ""}
write -P0x69 0x3fe0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 393216,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 6 dirty sectors; have 6. OK!

--- Reference mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_1", "sync": "full", "target": "ref_target_1"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_1"}}
{"return": {}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_1 ---
{}
{}

--- Prepare bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_1", "sync": "full", "target": "mirror_target_1"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "mirror_1"}}
{"return": {}}
{"data": {"device": "mirror_1", "len": 393216, "offset": 393216, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"execute": "job-finalize", "arguments": {"id": "mirror_1"}}
{"return": {}}
{"data": {"id": "mirror_1", "type": "mirror"}, "event": "BLOCK_JOB_PENDING", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_1", "len": 393216, "offset": 393216, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_1 ---
{}
{}

--- Post-process bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 393216,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 6 dirty sectors; have 6. OK!

--- Reference mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_2", "sync": "full", "target": "ref_target_2"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_2"}}
{"return": {}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_2 ---
{}
{}

--- Prepare bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_2", "sync": "full", "target": "mirror_target_2"}}
{"return": {}}
--- Write #2 ---

write -P0x74 0x0010000 0x10000
{"return": ""}
write -P0x69 0x00e8000 0x10000
{"return": ""}
write -P0x6e 0x2018000 0x10000
{"return": ""}
write -P0x67 0x3fe0000 0x20000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": true,
        "count": 0,
        "granularity": 65536,
        "name": "mirror-bitmap",
        "persistent": false,
        "recording": false
      },
      {
        "busy": false,
        "count": 655360,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 10 dirty sectors; have 10. OK!

--- Detaching mirror_target_2 ---
{}
{}

--- Post-process bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

= Checking Bitmap bitmap0 =
expecting 10 dirty sectors; have 10. OK!

--- Write #3 ---

write -P0xaa 0x0010000 0x30000
{"return": ""}
write -P0xbb 0x00d8000 0x10000
{"return": ""}
write -P0xcc 0x2028000 0x10000
{"return": ""}
write -P0xdd 0x3fc0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 983040,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 15 dirty sectors; have 15. OK!

--- Reference mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_3", "sync": "full", "target": "ref_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_3"}}
{"return": {}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_3 ---
{}
{}

--- Prepare bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_3", "sync": "full", "target": "mirror_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"device": "mirror_3", "len": 983040, "offset": 983040, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"execute": "job-finalize", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"id": "mirror_3", "type": "mirror"}, "event": "BLOCK_JOB_PENDING", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_3", "len": 983040, "offset": 983040, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_3 ---
{}
{}

--- Post-process bitmap for sync mode 'never' ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 983040,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 15 dirty sectors; have 15. OK!

--- Cleanup ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "bitmap0", "node": "drive0"}}
{"return": {}}
{
  "bitmaps": {}
}

--- Verification ---

qemu_img compare "TEST_DIR/PID-bsync1" "TEST_DIR/PID-fmirror1" ==> Identical, OK!
qemu_img compare "TEST_DIR/PID-bsync2" "TEST_DIR/PID-fmirror2" ==> Mismatch, OK!
qemu_img compare "TEST_DIR/PID-bsync3" "TEST_DIR/PID-fmirror3" ==> Identical, OK!
qemu_img compare "TEST_DIR/PID-img" "TEST_DIR/PID-fmirror3" ==> Identical, OK!


=== Bitmap Sync on-success with simulated failure ===

--- Preparing image & VM ---

{"execute": "blockdev-add", "arguments": {"driver": "qcow2", "file": {"driver": "file", "filename": "TEST_DIR/PID-img"}, "node-name": "drive0"}}
{"return": {}}

--- Write #0 ---

write -P0x49 0x0000000 0x10000
{"return": ""}
write -P0x6c 0x0100000 0x10000
{"return": ""}
write -P0x6f 0x2000000 0x10000
{"return": ""}
write -P0x76 0x3ff0000 0x10000
{"return": ""}
{
  "bitmaps": {}
}

--- Reference mirror #0 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_0", "sync": "full", "target": "ref_target_0"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_0"}}
{"return": {}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_0 ---
{}
{}

--- Add Bitmap ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "bitmap0", "node": "drive0"}}
{"return": {}}

--- Write #1 ---

write -P0x65 0x0000000 0x10000
{"return": ""}
write -P0x77 0x00f8000 0x10000
{"return": ""}
write -P0x72 0x2008000 0x10000
{"return": ""}
write -P0x69 0x3fe0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 393216,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 6 dirty sectors; have 6. OK!

--- Reference mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_1", "sync": "full", "target": "ref_target_1"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_1"}}
{"return": {}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_1 ---
{}
{}

--- Prepare bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_1", "sync": "full", "target": "mirror_target_1"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "mirror_1"}}
{"return": {}}
{"data": {"device": "mirror_1", "len": 393216, "offset": 393216, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"execute": "job-cancel", "arguments": {"id": "mirror_1"}}
{"return": {}}
{"data": {"id": "mirror_1", "type": "mirror"}, "event": "BLOCK_JOB_PENDING", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_1", "len": 393216, "offset": 393216, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_CANCELLED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_1 ---
{}
{}

--- Post-process bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 393216,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 6 dirty sectors; have 6. OK!

--- Reference mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_2", "sync": "full", "target": "ref_target_2"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_2"}}
{"return": {}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_2 ---
{}
{}

--- Prepare bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_2", "sync": "full", "target": "mirror_target_2"}}
{"return": {}}
--- Write #2 ---

write -P0x74 0x0010000 0x10000
{"return": ""}
write -P0x69 0x00e8000 0x10000
{"return": ""}
write -P0x6e 0x2018000 0x10000
{"return": ""}
write -P0x67 0x3fe0000 0x20000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": true,
        "count": 0,
        "granularity": 65536,
        "name": "mirror-bitmap",
        "persistent": false,
        "recording": false
      },
      {
        "busy": false,
        "count": 655360,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 10 dirty sectors; have 10. OK!

--- Detaching mirror_target_2 ---
{}
{}

--- Post-process bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-clear", "arguments": {"name": "bitmap0", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["mirror-bitmap"], "node": "drive0", "target": "bitmap0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

= Checking Bitmap bitmap0 =
expecting 0 dirty sectors; have 0. OK!

--- Write #3 ---

write -P0xaa 0x0010000 0x30000
{"return": ""}
write -P0xbb 0x00d8000 0x10000
{"return": ""}
write -P0xcc 0x2028000 0x10000
{"return": ""}
write -P0xdd 0x3fc0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 524288,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 8 dirty sectors; have 8. OK!

--- Reference mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_3", "sync": "full", "target": "ref_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_3"}}
{"return": {}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_3 ---
{}
{}

--- Prepare bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_3", "sync": "full", "target": "mirror_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"device": "mirror_3", "len": 524288, "offset": 524288, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"execute": "job-finalize", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"id": "mirror_3", "type": "mirror"}, "event": "BLOCK_JOB_PENDING", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_3", "len": 524288, "offset": 524288, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_3 ---
{}
{}

--- Post-process bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-clear", "arguments": {"name": "bitmap0", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["mirror-bitmap"], "node": "drive0", "target": "bitmap0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 0,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 0 dirty sectors; have 0. OK!

--- Cleanup ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "bitmap0", "node": "drive0"}}
{"return": {}}
{
  "bitmaps": {}
}

--- Verification ---

qemu_img compare "TEST_DIR/PID-bsync1" "TEST_DIR/PID-fmirror1" ==> Identical, OK!
qemu_img compare "TEST_DIR/PID-bsync2" "TEST_DIR/PID-fmirror2" ==> Mismatch, OK!
qemu_img compare "TEST_DIR/PID-bsync3" "TEST_DIR/PID-fmirror3" ==> Identical, OK!
qemu_img compare "TEST_DIR/PID-img" "TEST_DIR/PID-fmirror3" ==> Identical, OK!


=== Bitmap Sync on-success with intermediate failure ===

--- Preparing image & VM ---

{"execute": "blockdev-add", "arguments": {"driver": "qcow2", "file": {"driver": "blkdebug", "image": {"driver": "file", "filename": "TEST_DIR/PID-img"}, "inject-error": [{"errno": 5, "event": "read_aio", "immediately": false, "once": true, "state": 3}, {"errno": 5, "event": "read_aio", "immediately": false, "once": true, "state": 4}], "set-state": [{"event": "flush_to_disk", "new-state": 2, "state": 1}, {"event": "read_aio", "new-state": 3, "state": 2}, {"event": "read_aio", "new-state": 4, "state": 3}]}, "node-name": "drive0"}}
{"return": {}}

--- Write #0 ---

write -P0x49 0x0000000 0x10000
{"return": ""}
write -P0x6c 0x0100000 0x10000
{"return": ""}
write -P0x6f 0x2000000 0x10000
{"return": ""}
write -P0x76 0x3ff0000 0x10000
{"return": ""}
{
  "bitmaps": {}
}

--- Reference mirror #0 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_0", "sync": "full", "target": "ref_target_0"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_0"}}
{"return": {}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_0 ---
{}
{}

--- Add Bitmap ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "bitmap0", "node": "drive0"}}
{"return": {}}

--- Write #1 ---

write -P0x65 0x0000000 0x10000
{"return": ""}
write -P0x77 0x00f8000 0x10000
{"return": ""}
write -P0x72 0x2008000 0x10000
{"return": ""}
write -P0x69 0x3fe0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 393216,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 6 dirty sectors; have 6. OK!

--- Reference mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_1", "sync": "full", "target": "ref_target_1"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_1"}}
{"return": {}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_1 ---
{}
{}

{"return": ""}

--- Prepare bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_1", "sync": "full", "target": "mirror_target_1"}}
{"return": {}}
{"data": {"action": "report", "device": "mirror_1", "operation": "read"}, "event": "BLOCK_JOB_ERROR", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"action": "report", "device": "mirror_1", "operation": "read"}, "event": "BLOCK_JOB_ERROR", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_1", "error": "Input/output error", "len": 393216, "offset": 65536, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_1 ---
{}
{}

--- Post-process bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 393216,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 6 dirty sectors; have 6. OK!

--- Reference mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_2", "sync": "full", "target": "ref_target_2"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_2"}}
{"return": {}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_2 ---
{}
{}

--- Prepare bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_2", "sync": "full", "target": "mirror_target_2"}}
{"return": {}}
--- Write #2 ---

write -P0x74 0x0010000 0x10000
{"return": ""}
write -P0x69 0x00e8000 0x10000
{"return": ""}
write -P0x6e 0x2018000 0x10000
{"return": ""}
write -P0x67 0x3fe0000 0x20000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": true,
        "count": 0,
        "granularity": 65536,
        "name": "mirror-bitmap",
        "persistent": false,
        "recording": false
      },
      {
        "busy": false,
        "count": 655360,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 10 dirty sectors; have 10. OK!

--- Detaching mirror_target_2 ---
{}
{}

--- Post-process bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-clear", "arguments": {"name": "bitmap0", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["mirror-bitmap"], "node": "drive0", "target": "bitmap0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

= Checking Bitmap bitmap0 =
expecting 0 dirty sectors; have 0. OK!

--- Write #3 ---

write -P0xaa 0x0010000 0x30000
{"return": ""}
write -P0xbb 0x00d8000 0x10000
{"return": ""}
write -P0xcc 0x2028000 0x10000
{"return": ""}
write -P0xdd 0x3fc0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 524288,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 8 dirty sectors; have 8. OK!

--- Reference mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_3", "sync": "full", "target": "ref_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_3"}}
{"return": {}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_3 ---
{}
{}

--- Prepare bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_3", "sync": "full", "target": "mirror_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"device": "mirror_3", "len": 524288, "offset": 524288, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"execute": "job-finalize", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"id": "mirror_3", "type": "mirror"}, "event": "BLOCK_JOB_PENDING", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_3", "len": 524288, "offset": 524288, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_3 ---
{}
{}

--- Post-process bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-clear", "arguments": {"name": "bitmap0", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["mirror-bitmap"], "node": "drive0", "target": "bitmap0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 0,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 0 dirty sectors; have 0. OK!

--- Cleanup ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "bitmap0", "node": "drive0"}}
{"return": {}}
{
  "bitmaps": {}
}

--- Verification ---

qemu_img compare "TEST_DIR/PID-bsync1" "TEST_DIR/PID-fmirror1" ==> Mismatch, OK!
qemu_img compare "TEST_DIR/PID-bsync2" "TEST_DIR/PID-fmirror2" ==> Mismatch, OK!
qemu_img compare "TEST_DIR/PID-bsync3" "TEST_DIR/PID-fmirror3" ==> Identical, OK!
qemu_img compare "TEST_DIR/PID-img" "TEST_DIR/PID-fmirror3" ==> Identical, OK!


=== Bitmap Sync on-success without failure ===

--- Preparing image & VM ---

{"execute": "blockdev-add", "arguments": {"driver": "qcow2", "file": {"driver": "file", "filename": "TEST_DIR/PID-img"}, "node-name": "drive0"}}
{"return": {}}

--- Write #0 ---

write -P0x49 0x0000000 0x10000
{"return": ""}
write -P0x6c 0x0100000 0x10000
{"return": ""}
write -P0x6f 0x2000000 0x10000
{"return": ""}
write -P0x76 0x3ff0000 0x10000
{"return": ""}
{
  "bitmaps": {}
}

--- Reference mirror #0 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_0", "sync": "full", "target": "ref_target_0"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_0"}}
{"return": {}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_0 ---
{}
{}

--- Add Bitmap ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "bitmap0", "node": "drive0"}}
{"return": {}}

--- Write #1 ---

write -P0x65 0x0000000 0x10000
{"return": ""}
write -P0x77 0x00f8000 0x10000
{"return": ""}
write -P0x72 0x2008000 0x10000
{"return": ""}
write -P0x69 0x3fe0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 393216,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 6 dirty sectors; have 6. OK!

--- Reference mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_1", "sync": "full", "target": "ref_target_1"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_1"}}
{"return": {}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_1 ---
{}
{}

--- Prepare bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_1", "sync": "full", "target": "mirror_target_1"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "mirror_1"}}
{"return": {}}
{"data": {"device": "mirror_1", "len": 393216, "offset": 393216, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"execute": "job-finalize", "arguments": {"id": "mirror_1"}}
{"return": {}}
{"data": {"id": "mirror_1", "type": "mirror"}, "event": "BLOCK_JOB_PENDING", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_1", "len": 393216, "offset": 393216, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_1 ---
{}
{}

--- Post-process bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-clear", "arguments": {"name": "bitmap0", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["mirror-bitmap"], "node": "drive0", "target": "bitmap0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 0,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 0 dirty sectors; have 0. OK!

--- Reference mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_2", "sync": "full", "target": "ref_target_2"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_2"}}
{"return": {}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_2 ---
{}
{}

--- Prepare bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_2", "sync": "full", "target": "mirror_target_2"}}
{"return": {}}
--- Write #2 ---

write -P0x74 0x0010000 0x10000
{"return": ""}
write -P0x69 0x00e8000 0x10000
{"return": ""}
write -P0x6e 0x2018000 0x10000
{"return": ""}
write -P0x67 0x3fe0000 0x20000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": true,
        "count": 0,
        "granularity": 65536,
        "name": "mirror-bitmap",
        "persistent": false,
        "recording": false
      },
      {
        "busy": false,
        "count": 458752,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 7 dirty sectors; have 7. OK!

--- Detaching mirror_target_2 ---
{}
{}

--- Post-process bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-clear", "arguments": {"name": "bitmap0", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["mirror-bitmap"], "node": "drive0", "target": "bitmap0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

= Checking Bitmap bitmap0 =
expecting 0 dirty sectors; have 0. OK!

--- Write #3 ---

write -P0xaa 0x0010000 0x30000
{"return": ""}
write -P0xbb 0x00d8000 0x10000
{"return": ""}
write -P0xcc 0x2028000 0x10000
{"return": ""}
write -P0xdd 0x3fc0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 524288,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 8 dirty sectors; have 8. OK!

--- Reference mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_3", "sync": "full", "target": "ref_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_3"}}
{"return": {}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_3 ---
{}
{}

--- Prepare bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["bitmap0"], "node": "drive0", "target": "mirror-bitmap"}}
{"return": {}}

--- Test mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "mirror-bitmap", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_3", "sync": "full", "target": "mirror_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"device": "mirror_3", "len": 524288, "offset": 524288, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"execute": "job-finalize", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"id": "mirror_3", "type": "mirror"}, "event": "BLOCK_JOB_PENDING", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_3", "len": 524288, "offset": 524288, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_3 ---
{}
{}

--- Post-process bitmap for sync mode 'on-success' ---

{"execute": "block-dirty-bitmap-clear", "arguments": {"name": "bitmap0", "node": "drive0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-merge", "arguments": {"bitmaps": ["mirror-bitmap"], "node": "drive0", "target": "bitmap0"}}
{"return": {}}
{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "mirror-bitmap", "node": "drive0"}}
{"return": {}}

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 0,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 0 dirty sectors; have 0. OK!

--- Cleanup ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "bitmap0", "node": "drive0"}}
{"return": {}}
{
  "bitmaps": {}
}

--- Verification ---

qemu_img compare "TEST_DIR/PID-bsync1" "TEST_DIR/PID-fmirror1" ==> Identical, OK!
qemu_img compare "TEST_DIR/PID-bsync2" "TEST_DIR/PID-fmirror2" ==> Mismatch, OK!
qemu_img compare "TEST_DIR/PID-bsync3" "TEST_DIR/PID-fmirror3" ==> Identical, OK!
qemu_img compare "TEST_DIR/PID-img" "TEST_DIR/PID-fmirror3" ==> Identical, OK!


=== Bitmap Sync always with simulated failure ===

--- Preparing image & VM ---

{"execute": "blockdev-add", "arguments": {"driver": "qcow2", "file": {"driver": "file", "filename": "TEST_DIR/PID-img"}, "node-name": "drive0"}}
{"return": {}}

--- Write #0 ---

write -P0x49 0x0000000 0x10000
{"return": ""}
write -P0x6c 0x0100000 0x10000
{"return": ""}
write -P0x6f 0x2000000 0x10000
{"return": ""}
write -P0x76 0x3ff0000 0x10000
{"return": ""}
{
  "bitmaps": {}
}

--- Reference mirror #0 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_0", "sync": "full", "target": "ref_target_0"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_0"}}
{"return": {}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_0 ---
{}
{}

--- Add Bitmap ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "bitmap0", "node": "drive0"}}
{"return": {}}

--- Write #1 ---

write -P0x65 0x0000000 0x10000
{"return": ""}
write -P0x77 0x00f8000 0x10000
{"return": ""}
write -P0x72 0x2008000 0x10000
{"return": ""}
write -P0x69 0x3fe0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 393216,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 6 dirty sectors; have 6. OK!

--- Reference mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_1", "sync": "full", "target": "ref_target_1"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_1"}}
{"return": {}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_1 ---
{}
{}

--- Prepare bitmap for sync mode 'always' ---

passing current bitmap 'bitmap0'

--- Test mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "bitmap0", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_1", "sync": "full", "target": "mirror_target_1"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "mirror_1"}}
{"return": {}}
{"data": {"device": "mirror_1", "len": 393216, "offset": 393216, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"execute": "job-cancel", "arguments": {"id": "mirror_1"}}
{"return": {}}
{"data": {"id": "mirror_1", "type": "mirror"}, "event": "BLOCK_JOB_PENDING", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_1", "len": 393216, "offset": 393216, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_CANCELLED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_1 ---
{}
{}

--- Post-process bitmap for sync mode 'always' ---

nothing to do

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 0,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 0 dirty sectors; have 0. OK!

--- Reference mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_2", "sync": "full", "target": "ref_target_2"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_2"}}
{"return": {}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_2 ---
{}
{}

--- Prepare bitmap for sync mode 'always' ---

passing current bitmap 'bitmap0'

--- Test mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "bitmap0", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_2", "sync": "full", "target": "mirror_target_2"}}
{"return": {}}
--- Write #2 ---

write -P0x74 0x0010000 0x10000
{"return": ""}
write -P0x69 0x00e8000 0x10000
{"return": ""}
write -P0x6e 0x2018000 0x10000
{"return": ""}
write -P0x67 0x3fe0000 0x20000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": true,
        "count": 0,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": false
      }
    ]
  }
}

--- Detaching mirror_target_2 ---
{}
{}

--- Post-process bitmap for sync mode 'always' ---

nothing to do

= Checking Bitmap bitmap0 =
expecting 0 dirty sectors; have 0. OK!

--- Write #3 ---

write -P0xaa 0x0010000 0x30000
{"return": ""}
write -P0xbb 0x00d8000 0x10000
{"return": ""}
write -P0xcc 0x2028000 0x10000
{"return": ""}
write -P0xdd 0x3fc0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 524288,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 8 dirty sectors; have 8. OK!

--- Reference mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_3", "sync": "full", "target": "ref_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_3"}}
{"return": {}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_3 ---
{}
{}

--- Prepare bitmap for sync mode 'always' ---

passing current bitmap 'bitmap0'

--- Test mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "bitmap0", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_3", "sync": "full", "target": "mirror_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"device": "mirror_3", "len": 524288, "offset": 524288, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"execute": "job-finalize", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"id": "mirror_3", "type": "mirror"}, "event": "BLOCK_JOB_PENDING", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_3", "len": 524288, "offset": 524288, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_3 ---
{}
{}

--- Post-process bitmap for sync mode 'always' ---

nothing to do

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 0,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 0 dirty sectors; have 0. OK!

--- Cleanup ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "bitmap0", "node": "drive0"}}
{"return": {}}
{
  "bitmaps": {}
}

--- Verification ---

qemu_img compare "TEST_DIR/PID-bsync1" "TEST_DIR/PID-fmirror1" ==> Identical, OK!
qemu_img compare "TEST_DIR/PID-bsync2" "TEST_DIR/PID-fmirror2" ==> Mismatch, OK!
qemu_img compare "TEST_DIR/PID-bsync3" "TEST_DIR/PID-fmirror3" ==> Identical, OK!
qemu_img compare "TEST_DIR/PID-img" "TEST_DIR/PID-fmirror3" ==> Identical, OK!


=== Bitmap Sync always with intermediate failure ===

--- Preparing image & VM ---

{"execute": "blockdev-add", "arguments": {"driver": "qcow2", "file": {"driver": "blkdebug", "image": {"driver": "file", "filename": "TEST_DIR/PID-img"}, "inject-error": [{"errno": 5, "event": "read_aio", "immediately": false, "once": true, "state": 3}, {"errno": 5, "event": "read_aio", "immediately": false, "once": true, "state": 4}], "set-state": [{"event": "flush_to_disk", "new-state": 2, "state": 1}, {"event": "read_aio", "new-state": 3, "state": 2}, {"event": "read_aio", "new-state": 4, "state": 3}]}, "node-name": "drive0"}}
{"return": {}}

--- Write #0 ---

write -P0x49 0x0000000 0x10000
{"return": ""}
write -P0x6c 0x0100000 0x10000
{"return": ""}
write -P0x6f 0x2000000 0x10000
{"return": ""}
write -P0x76 0x3ff0000 0x10000
{"return": ""}
{
  "bitmaps": {}
}

--- Reference mirror #0 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_0", "sync": "full", "target": "ref_target_0"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_0"}}
{"return": {}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_0 ---
{}
{}

--- Add Bitmap ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "bitmap0", "node": "drive0"}}
{"return": {}}

--- Write #1 ---

write -P0x65 0x0000000 0x10000
{"return": ""}
write -P0x77 0x00f8000 0x10000
{"return": ""}
write -P0x72 0x2008000 0x10000
{"return": ""}
write -P0x69 0x3fe0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 393216,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 6 dirty sectors; have 6. OK!

--- Reference mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_1", "sync": "full", "target": "ref_target_1"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_1"}}
{"return": {}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_1 ---
{}
{}

{"return": ""}

--- Prepare bitmap for sync mode 'always' ---

passing current bitmap 'bitmap0'

--- Test mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "bitmap0", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_1", "sync": "full", "target": "mirror_target_1"}}
{"return": {}}
{"data": {"action": "report", "device": "mirror_1", "operation": "read"}, "event": "BLOCK_JOB_ERROR", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"action": "report", "device": "mirror_1", "operation": "read"}, "event": "BLOCK_JOB_ERROR", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_1", "error": "Input/output error", "len": 393216, "offset": 65536, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_1 ---
{}
{}

--- Post-process bitmap for sync mode 'always' ---

nothing to do

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 327680,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 5 dirty sectors; have 5. OK!

--- Reference mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_2", "sync": "full", "target": "ref_target_2"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_2"}}
{"return": {}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_2 ---
{}
{}

--- Prepare bitmap for sync mode 'always' ---

passing current bitmap 'bitmap0'

--- Test mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "bitmap0", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_2", "sync": "full", "target": "mirror_target_2"}}
{"return": {}}
--- Write #2 ---

write -P0x74 0x0010000 0x10000
{"return": ""}
write -P0x69 0x00e8000 0x10000
{"return": ""}
write -P0x6e 0x2018000 0x10000
{"return": ""}
write -P0x67 0x3fe0000 0x20000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": true,
        "count": 0,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": false
      }
    ]
  }
}

--- Detaching mirror_target_2 ---
{}
{}

--- Post-process bitmap for sync mode 'always' ---

nothing to do

= Checking Bitmap bitmap0 =
expecting 0 dirty sectors; have 0. OK!

--- Write #3 ---

write -P0xaa 0x0010000 0x30000
{"return": ""}
write -P0xbb 0x00d8000 0x10000
{"return": ""}
write -P0xcc 0x2028000 0x10000
{"return": ""}
write -P0xdd 0x3fc0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 524288,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 8 dirty sectors; have 8. OK!

--- Reference mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_3", "sync": "full", "target": "ref_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_3"}}
{"return": {}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_3 ---
{}
{}

--- Prepare bitmap for sync mode 'always' ---

passing current bitmap 'bitmap0'

--- Test mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "bitmap0", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_3", "sync": "full", "target": "mirror_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"device": "mirror_3", "len": 524288, "offset": 524288, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"execute": "job-finalize", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"id": "mirror_3", "type": "mirror"}, "event": "BLOCK_JOB_PENDING", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_3", "len": 524288, "offset": 524288, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_3 ---
{}
{}

--- Post-process bitmap for sync mode 'always' ---

nothing to do

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 0,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 0 dirty sectors; have 0. OK!

--- Cleanup ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "bitmap0", "node": "drive0"}}
{"return": {}}
{
  "bitmaps": {}
}

--- Verification ---

qemu_img compare "TEST_DIR/PID-bsync1" "TEST_DIR/PID-fmirror1" ==> Mismatch, OK!
qemu_img compare "TEST_DIR/PID-bsync2" "TEST_DIR/PID-fmirror2" ==> Mismatch, OK!
qemu_img compare "TEST_DIR/PID-bsync3" "TEST_DIR/PID-fmirror3" ==> Identical, OK!
qemu_img compare "TEST_DIR/PID-img" "TEST_DIR/PID-fmirror3" ==> Identical, OK!


=== Bitmap Sync always without failure ===

--- Preparing image & VM ---

{"execute": "blockdev-add", "arguments": {"driver": "qcow2", "file": {"driver": "file", "filename": "TEST_DIR/PID-img"}, "node-name": "drive0"}}
{"return": {}}

--- Write #0 ---

write -P0x49 0x0000000 0x10000
{"return": ""}
write -P0x6c 0x0100000 0x10000
{"return": ""}
write -P0x6f 0x2000000 0x10000
{"return": ""}
write -P0x76 0x3ff0000 0x10000
{"return": ""}
{
  "bitmaps": {}
}

--- Reference mirror #0 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_0", "sync": "full", "target": "ref_target_0"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_0"}}
{"return": {}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_0", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_0 ---
{}
{}

--- Add Bitmap ---

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "bitmap0", "node": "drive0"}}
{"return": {}}

--- Write #1 ---

write -P0x65 0x0000000 0x10000
{"return": ""}
write -P0x77 0x00f8000 0x10000
{"return": ""}
write -P0x72 0x2008000 0x10000
{"return": ""}
write -P0x69 0x3fe0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 393216,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 6 dirty sectors; have 6. OK!

--- Reference mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_1", "sync": "full", "target": "ref_target_1"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_1"}}
{"return": {}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_1", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_1 ---
{}
{}

--- Prepare bitmap for sync mode 'always' ---

passing current bitmap 'bitmap0'

--- Test mirror #1 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "bitmap0", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_1", "sync": "full", "target": "mirror_target_1"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "mirror_1"}}
{"return": {}}
{"data": {"device": "mirror_1", "len": 393216, "offset": 393216, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"execute": "job-finalize", "arguments": {"id": "mirror_1"}}
{"return": {}}
{"data": {"id": "mirror_1", "type": "mirror"}, "event": "BLOCK_JOB_PENDING", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_1", "len": 393216, "offset": 393216, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_1 ---
{}
{}

--- Post-process bitmap for sync mode 'always' ---

nothing to do

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 0,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 0 dirty sectors; have 0. OK!

--- Reference mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_2", "sync": "full", "target": "ref_target_2"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_2"}}
{"return": {}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_2", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_2 ---
{}
{}

--- Prepare bitmap for sync mode 'always' ---

passing current bitmap 'bitmap0'

--- Test mirror #2 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "bitmap0", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_2", "sync": "full", "target": "mirror_target_2"}}
{"return": {}}
--- Write #2 ---

write -P0x74 0x0010000 0x10000
{"return": ""}
write -P0x69 0x00e8000 0x10000
{"return": ""}
write -P0x6e 0x2018000 0x10000
{"return": ""}
write -P0x67 0x3fe0000 0x20000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": true,
        "count": 0,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": false
      }
    ]
  }
}

--- Detaching mirror_target_2 ---
{}
{}

--- Post-process bitmap for sync mode 'always' ---

nothing to do

= Checking Bitmap bitmap0 =
expecting 0 dirty sectors; have 0. OK!

--- Write #3 ---

write -P0xaa 0x0010000 0x30000
{"return": ""}
write -P0xbb 0x00d8000 0x10000
{"return": ""}
write -P0xcc 0x2028000 0x10000
{"return": ""}
write -P0xdd 0x3fc0000 0x10000
{"return": ""}
{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 524288,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 8 dirty sectors; have 8. OK!

--- Reference mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "ref_mirror_3", "sync": "full", "target": "ref_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "ref_mirror_3"}}
{"return": {}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "ref_mirror_3", "len": 67108864, "offset": 67108864, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}

--- Detaching ref_target_3 ---
{}
{}

--- Prepare bitmap for sync mode 'always' ---

passing current bitmap 'bitmap0'

--- Test mirror #3 ---

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}
{"execute": "blockdev-mirror", "arguments": {"auto-finalize": false, "bitmap": "bitmap0", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "mirror_3", "sync": "full", "target": "mirror_target_3"}}
{"return": {}}
{"execute": "job-complete", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"device": "mirror_3", "len": 524288, "offset": 524288, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_READY", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"execute": "job-finalize", "arguments": {"id": "mirror_3"}}
{"return": {}}
{"data": {"id": "mirror_3", "type": "mirror"}, "event": "BLOCK_JOB_PENDING", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
{"data": {"device": "mirror_3", "len": 524288, "offset": 524288, "speed": 0, "type": "mirror"}, "event": "BLOCK_JOB_COMPLETED", "timestamp": {"microseconds": "USECS", "seconds": "SECS"}}
--- Detaching mirror_target_3 ---
{}
{}

--- Post-process bitmap for sync mode 'always' ---

nothing to do

{
  "bitmaps": {
    "drive0": [
      {
        "busy": false,
        "count": 0,
        "granularity": 65536,
        "name": "bitmap0",
        "persistent": false,
        "recording": true
      }
    ]
  }
}

= Checking Bitmap bitmap0 =
expecting 0 dirty sectors; have 0. OK!

--- Cleanup ---

{"execute": "block-dirty-bitmap-remove", "arguments": {"name": "bitmap0", "node": "drive0"}}
{"return": {}}
{
  "bitmaps": {}
}

--- Verification ---

qemu_img compare "TEST_DIR/PID-bsync1" "TEST_DIR/PID-fmirror1" ==> Identical, OK!
qemu_img compare "TEST_DIR/PID-bsync2" "TEST_DIR/PID-fmirror2" ==> Mismatch, OK!
qemu_img compare "TEST_DIR/PID-bsync3" "TEST_DIR/PID-fmirror3" ==> Identical, OK!
qemu_img compare "TEST_DIR/PID-img" "TEST_DIR/PID-fmirror3" ==> Identical, OK!


=== API failure tests ===

--- Preparing image & VM ---

{"execute": "blockdev-add", "arguments": {"driver": "qcow2", "file": {"driver": "file", "filename": "TEST_DIR/PID-img"}, "node-name": "drive0"}}
{"return": {}}

{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-file-job"}}
{"return": {}}
{}
{}
{"execute": "job-dismiss", "arguments": {"id": "bdc-fmt-job"}}
{"return": {}}
{}

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "bitmap0", "node": "drive0"}}
{"return": {}}

-- Testing invalid QMP commands --

-- Sync mode full tests --

{"execute": "blockdev-mirror", "arguments": {"bitmap": "bitmap404", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "api_job", "sync": "full", "target": "mirror_target"}}
{"error": {"class": "GenericError", "desc": "Dirty bitmap 'bitmap404' not found"}}

-- Sync mode top tests --

{"execute": "blockdev-mirror", "arguments": {"bitmap": "bitmap404", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "api_job", "sync": "top", "target": "mirror_target"}}
{"error": {"class": "GenericError", "desc": "Sync mode 'top' not supported with bitmap."}}

{"execute": "blockdev-mirror", "arguments": {"bitmap": "bitmap0", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "api_job", "sync": "top", "target": "mirror_target"}}
{"error": {"class": "GenericError", "desc": "Sync mode 'top' not supported with bitmap."}}

-- Sync mode none tests --

{"execute": "blockdev-mirror", "arguments": {"bitmap": "bitmap404", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "api_job", "sync": "none", "target": "mirror_target"}}
{"error": {"class": "GenericError", "desc": "Sync mode 'none' not supported with bitmap."}}

{"execute": "blockdev-mirror", "arguments": {"bitmap": "bitmap0", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "api_job", "sync": "none", "target": "mirror_target"}}
{"error": {"class": "GenericError", "desc": "Sync mode 'none' not supported with bitmap."}}

-- Test bitmap with too small granularity to non-COW target --

{"execute": "block-dirty-bitmap-add", "arguments": {"granularity": 65536, "name": "bitmap-small", "node": "drive0"}}
{"return": {}}
{"execute": "blockdev-mirror", "arguments": {"bitmap": "bitmap-small", "copy-mode": "write-blocking", "device": "drive0", "filter-node-name": "mirror-top", "job-id": "api_job", "sync": "full", "target": "mirror_target"}}
{"error": {"class": "GenericError", "desc": "Bitmap granularity 65536 is not a multiple of the target image's cluster size 131072 and the target image has no backing file"}}

