#!/usr/bin/env python3
# group: rw quick
#
# Test what happens when a 'file' node below a 'raw' node is resized.
#
# Copyright (C) Proxmox Server Solutions GmbH
#
# SPDX-License-Identifier: GPL-2.0-or-later

import os
import iotests
from iotests import imgfmt, qemu_img_create, QMPTestCase

image_size = 1 * 1024 * 1024
image = os.path.join(iotests.test_dir, 'test.img')

class TestResizeBelowRaw(QMPTestCase):
    def setUp(self) -> None:
        qemu_img_create('-f', imgfmt, image, str(image_size))

        self.vm = iotests.VM()
        self.vm.add_blockdev(self.vm.qmp_to_opts({
            'driver': imgfmt,
            'node-name': 'node0',
            'file': {
                'driver': 'file',
                'filename': image,
                'node-name': 'file0',
            }
        }))
        self.vm.launch()

    def tearDown(self) -> None:
        self.vm.shutdown()
        os.remove(image)

    def assert_size(self, size: int) -> None:
        nodes = self.vm.qmp('query-named-block-nodes', flat=True)['return']
        self.assertEqual(len(nodes), 2)
        for node in nodes:
            if node['drv'] == 'file':
                continue
            self.assertEqual(node['image']['virtual-size'], size)

    def test_resize_below_raw(self) -> None:
        self.assert_size(image_size)
        self.vm.qmp('block_resize', node_name='file0', size=2*image_size)
        self.assert_size(2*image_size)
        self.vm.qmp('block_resize', node_name='node0', size=3*image_size)
        self.assert_size(3*image_size)

if __name__ == '__main__':
    iotests.main(supported_fmts=['raw'], supported_protocols=['file'])
