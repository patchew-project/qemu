# -*- Mode: Python -*-
# vim: filetype=python

##
# = KVM based feature API
##

##
# @KVMPMUFilterAction:
#
# Actions that KVM PMU filter supports.
#
# @deny: disable the PMU event/counter in KVM PMU filter
#
# @allow: enable the PMU event/counter in KVM PMU filter
#
# Since 9.1
##
{ 'enum': 'KVMPMUFilterAction',
  'prefix': 'KVM_PMU_FILTER_ACTION',
  'data': ['allow', 'deny'] }

##
# @KVMPMUEventEncodeFmt:
#
# Encoding formats of PMU event that QEMU/KVM supports.
#
# @raw: the encoded event code that KVM can directly consume.
#
# @x86-default: standard x86 encoding format with select and umask.
#
# @x86-masked-entry: KVM's masked entry format for x86, which could
#                    mask bunch of events.
#
# Since 9.1
##
{ 'enum': 'KVMPMUEventEncodeFmt',
  'prefix': 'KVM_PMU_EVENT_FMT',
  'data': ['raw', 'x86-default', 'x86-masked-entry'] }

##
# @KVMPMURawEvent:
#
# Raw PMU event code.
#
# @code: the raw value that has been encoded, and QEMU could deliver
#     to KVM directly.
#
# Since 9.1
##
{ 'struct': 'KVMPMURawEvent',
  'data': { 'code': 'uint64' } }

##
# @KVMPMUX86DefalutEvent:
#
# x86 PMU event encoding with select and umask.
# raw_event = ((select & 0xf00UL) << 24) | \
#              (select) & 0xff) | \
#              ((umask) & 0xff) << 8)
#
# @select: x86 PMU event select field, which is a 12-bit unsigned
#     number.
#
# @umask: x86 PMU event umask field.
#
# Since 9.1
##
{ 'struct': 'KVMPMUX86DefalutEvent',
  'data': { 'select': 'uint16',
            'umask': 'uint8' } }

##
# @KVMPMUX86MaskedEntry:
#
# x86 PMU events encoding in KVM masked entry format.
#
# Encoding layout:
# Bits   Description
# ----   -----------
# 7:0    event select (low bits)
# 15:8   (umask) match
# 31:16  unused
# 35:32  event select (high bits)
# 36:54  unused
# 55     exclude bit
# 63:56  (umask) mask
#
# Events are selected by (umask & mask == match)
#
# @select: x86 PMU event select, which is a 12-bit unsigned number.
#
# @match: umask match.
#
# @mask: umask mask
#
# @exclude: Whether the matched events are excluded.
#
# Since 9.1
##
{ 'struct': 'KVMPMUX86MaskedEntry',
  'data': { 'select': 'uint16',
            'match': 'uint8',
            'mask': 'uint8',
            'exclude': 'bool' } }

##
# @KVMPMUFilterEvent:
#
# PMU event filtered by KVM.
#
# @action: action that KVM PMU filter will take.
#
# @format: PMU event format.
#
# Since 9.1
##
{ 'union': 'KVMPMUFilterEvent',
  'base': { 'action': 'KVMPMUFilterAction',
            'format': 'KVMPMUEventEncodeFmt' },
  'discriminator': 'format',
  'data': { 'raw': 'KVMPMURawEvent',
            'x86-default': 'KVMPMUX86DefalutEvent',
            'x86-masked-entry': 'KVMPMUX86MaskedEntry' } }

##
# @KVMPMUFilterProperty:
#
# Property of KVM PMU Filter.
#
# @events: the KVMPMUFilterEvent list.
#
# Since 9.1
##
{ 'struct': 'KVMPMUFilterProperty',
  'data': { '*events': ['KVMPMUFilterEvent'] } }

##
# @KVMPMURawEventVariant:
#
# The variant of KVMPMURawEvent with the string, rather than the
# numeric value.
#
# @code: the raw value that has been encoded, and QEMU could deliver
#     to KVM directly.  This field is a uint64 string.
#
# Since 9.1
##
{ 'struct': 'KVMPMURawEventVariant',
  'data': { 'code': 'str' } }

##
# @KVMPMUX86DefalutEventVariant:
#
# The variant of KVMPMUX86DefalutEvent with the string, rather than
# the numeric value.
#
# @select: x86 PMU event select field.  This field is a 12-bit
#     unsigned number string.
#
# @umask: x86 PMU event umask field. This field is a uint8 string.
#
# Since 9.1
##
{ 'struct': 'KVMPMUX86DefalutEventVariant',
  'data': { 'select': 'str',
            'umask': 'str' } }

##
# @KVMPMUX86MaskedEntryVariant:
#
# The variant of KVMPMUX86MaskedEntry with the string, rather than
# the numeric value.
#
# @select: x86 PMU event select.  This field is a 12-bit unsigned
#     number string.
#
# @match: umask match.  This field is a uint8 string.
#
# @mask: umask mask.  This field is a uint8 string.
#
# @exclude: Whether the matched events are excluded.
#
# Since 9.1
##
{ 'struct': 'KVMPMUX86MaskedEntryVariant',
  'data': { 'select': 'str',
            'match': 'str',
            'mask': 'str',
            'exclude': 'bool' } }

##
# @KVMPMUFilterEventVariant:
#
# The variant of KVMPMUFilterEvent.
#
# @action: action that KVM PMU filter will take.
#
# @format: PMU event format.
#
# Since 9.1
##
{ 'union': 'KVMPMUFilterEventVariant',
  'base': { 'action': 'KVMPMUFilterAction',
            'format': 'KVMPMUEventEncodeFmt' },
  'discriminator': 'format',
  'data': { 'raw': 'KVMPMURawEventVariant',
            'x86-default': 'KVMPMUX86DefalutEventVariant',
            'x86-masked-entry': 'KVMPMUX86MaskedEntryVariant' } }

##
# @KVMPMUFilterPropertyVariant:
#
# The variant of KVMPMUFilterProperty.
#
# @events: the KVMPMUFilterEventVariant list.
#
# Since 9.1
##
{ 'struct': 'KVMPMUFilterPropertyVariant',
  'data': { '*events': ['KVMPMUFilterEventVariant'] } }
