# -*- Mode: Python -*-
# vim: filetype=python
#
# Copyright (C) 2025 Intel Corporation.
#
# Author: Zhao Liu <zhao1.liu@intel.com>
#
# SPDX-License-Identifier: GPL-2.0-or-later

##
# == KVM
##

##
# === PMU stuff (KVM related)
##

##
# @KvmPmuFilterAction:
#
# Actions that KVM PMU filter supports.
#
# @deny: disable the PMU event/counter in KVM PMU filter.
#
# @allow: enable the PMU event/counter in KVM PMU filter.
#
# Since 10.1
##
{ 'enum': 'KvmPmuFilterAction',
  'data': ['allow', 'deny'] }

##
# @KvmPmuEventFormat:
#
# Encoding formats of PMU event that QEMU/KVM supports.
#
# @raw: the encoded event code that KVM can directly consume.
#
# @x86-select-umask: standard x86 encoding format with select and umask.
#
# @x86-masked-entry: KVM's masked entry format for x86, which could
#     mask bunch of events.
#
# Since 10.1
##
{ 'enum': 'KvmPmuEventFormat',
  'data': ['raw', 'x86-select-umask', 'x86-masked-entry'] }

##
# @KvmPmuRawEvent:
#
# Raw PMU event code.
#
# @code: the raw value that has been encoded, and QEMU could deliver
#     to KVM directly.
#
# Since 10.1
##
{ 'struct': 'KvmPmuRawEvent',
  'data': { 'code': 'uint64' } }

##
# @KvmPmuX86SelectUmaskEvent:
#
# @select: x86 PMU event select field, which is a 12-bit unsigned
#     number.
#
# @umask: x86 PMU event umask field.
#
# Since 10.1
##
{ 'struct': 'KvmPmuX86SelectUmaskEvent',
  'data': { 'select': 'uint16',
            'umask': 'uint8' } }

##
# @KvmPmuX86MaskedEntry:
#
# x86 PMU events encoding in KVM masked entry format.
#
# @select: x86 PMU event select, which is a 12-bit unsigned number.
#
# @match: umask match.
#
# @mask: umask mask.
#
# @exclude: whether the matched events are excluded.
#
# Since 10.1
##
{ 'struct': 'KvmPmuX86MaskedEntry',
  'data': { 'select': 'uint16',
            'match': 'uint8',
            'mask': 'uint8',
            'exclude': 'bool' } }

##
# @KvmPmuFilterEvent:
#
# PMU event filtered by KVM.
#
# @format: PMU event format.
#
# Since 10.1
##
{ 'union': 'KvmPmuFilterEvent',
  'base': { 'format': 'KvmPmuEventFormat' },
  'discriminator': 'format',
  'data': { 'raw': 'KvmPmuRawEvent',
            'x86-select-umask': 'KvmPmuX86SelectUmaskEvent',
            'x86-masked-entry': 'KvmPmuX86MaskedEntry' } }

##
# @KvmPmuFilterProperties:
#
# Properties of KVM PMU Filter.
#
# @action: action that KVM PMU filter will take for selected PMU events.
#
# @events: list of selected PMU events.
#
# Since 10.1
##
{ 'struct': 'KvmPmuFilterProperties',
  'data': { 'action': 'KvmPmuFilterAction',
            '*events': ['KvmPmuFilterEvent'] } }
